<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CATZ RUN ìº£ì¸ ëŸ° - ìŒì„± ì¡°ì‘ ëŸ¬ë„ˆ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" />
  <style>
    :root {
      --cat-primary: #FF9F43;
      --cat-secondary: #EE5A24;
      --cat-accent: #F8B500;
      --bg-gradient: linear-gradient(180deg, #FFF5E6 0%, #FFE4C4 50%, #FFDAB9 100%);
      --shadow: 0 4px 20px rgba(238, 90, 36, 0.2);
      --radius: 20px;
      --font: 'Pretendard Variable', 'Pretendard', -apple-system, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg-gradient);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ========== ê³µí†µ: í™”ë©´ ì „í™˜ ========== */
    .screen {
      display: none;
      min-height: 100vh;
      padding: 24px;
      animation: fadeIn 0.4s ease;
    }
    .screen.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ========== 1. ì¸íŠ¸ë¡œ ========== */
    .intro {
      text-align: center;
    }
    .intro-logo {
      font-size: clamp(2rem, 8vw, 4rem);
      font-weight: 800;
      color: var(--cat-secondary);
      text-shadow: 3px 3px 0 var(--cat-accent);
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }
    .intro-tagline {
      font-size: clamp(0.9rem, 3vw, 1.1rem);
      color: #666;
      margin-bottom: 40px;
    }
    .intro-cat {
      width: 140px;
      height: 140px;
      margin: 0 auto 32px;
      background: linear-gradient(145deg, var(--cat-primary), var(--cat-secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 72px;
      box-shadow: var(--shadow);
      animation: bounce 1.2s ease-in-out infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-12px); }
    }
    .intro-desc {
      max-width: 320px;
      font-size: 0.95rem;
      color: #555;
      line-height: 1.6;
      margin-bottom: 32px;
    }
    .btn-start {
      padding: 16px 48px;
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, var(--cat-secondary), var(--cat-primary));
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-start:hover { transform: scale(1.05); box-shadow: 0 6px 24px rgba(238,90,36,0.35); }
    .btn-secondary {
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--cat-secondary);
      background: rgba(255,255,255,0.85);
      border: 2px solid rgba(238, 90, 36, 0.25);
      border-radius: 999px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
      margin-top: 12px;
    }
    .btn-secondary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); background: #fff; }
    .link-btn { background: none; border: none; color: #888; cursor: pointer; font-size: inherit; text-decoration: underline; padding: 0; }
    .link-btn:hover { color: var(--cat-secondary); }

    /* ========== 2. ì˜¨ë³´ë”© ========== */
    .onboarding { max-width: 420px; width: 100%; }
    .onboarding h2 {
      font-size: 1.5rem;
      color: var(--cat-secondary);
      margin-bottom: 8px;
      text-align: center;
    }
    .onboarding p.sub { color: #666; font-size: 0.9rem; text-align: center; margin-bottom: 24px; }
    .voice-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }
    .voice-card {
      background: #fff;
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 2px solid transparent;
      transition: border-color 0.2s, transform 0.2s;
    }
    .voice-card.highlight { border-color: var(--cat-primary); transform: scale(1.02); }
    .voice-card .icon { font-size: 2rem; margin-bottom: 8px; }
    .voice-card .cmd { font-weight: 700; color: var(--cat-secondary); font-size: 0.95rem; }
    .voice-card .action { font-size: 0.8rem; color: #666; }
    .mic-demo {
      background: #fff;
      border-radius: var(--radius);
      padding: 24px;
      text-align: center;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    .mic-circle {
      width: 80px;
      height: 80px;
      margin: 0 auto 16px;
      border-radius: 50%;
      background: linear-gradient(145deg, #eee, #fff);
      border: 4px solid var(--cat-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255,159,67,0.4); }
      50% { box-shadow: 0 0 0 16px rgba(255,159,67,0); }
    }
    .mic-hint { font-size: 0.85rem; color: #888; }
    .btn-next { width: 100%; padding: 14px; font-size: 1rem; font-weight: 600; color: #fff; background: linear-gradient(135deg, var(--cat-secondary), var(--cat-primary)); border: none; border-radius: 50px; cursor: pointer; }

    /* ========== 3. ëª¨ë“œ ì„ íƒ ========== */
    .mode-select h2 { font-size: 1.5rem; color: var(--cat-secondary); margin-bottom: 24px; text-align: center; }
    .mode-cards { display: flex; flex-direction: column; gap: 16px; max-width: 360px; width: 100%; }
    .mode-card {
      background: #fff;
      border-radius: var(--radius);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      cursor: pointer;
      border: 3px solid transparent;
      transition: border-color 0.2s, transform 0.2s;
    }
    .mode-card:hover { border-color: var(--cat-accent); transform: translateX(4px); }
    .mode-card .emoji { font-size: 2.5rem; }
    .mode-card .title { font-weight: 700; color: #333; font-size: 1.1rem; }
    .mode-card .desc { font-size: 0.85rem; color: #666; margin-top: 4px; }
    .mode-card.classic .emoji { filter: none; }
    .mode-card.loud .emoji { filter: saturate(1.2); }
    .mode-card.whisper .emoji { filter: contrast(0.9); }

    /* ========== 4. ê²Œì„ í”Œë ˆì´ ========== */
    .gameplay-wrap { width: 100%; max-width: 480px; }
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 0 8px;
    }
    .game-score { font-size: 1.25rem; font-weight: 700; color: var(--cat-secondary); }
    .game-stats {
      display: flex;
      gap: 12px;
      font-size: 0.8rem;
      color: #666;
    }
    .game-stats span { background: #fff; padding: 4px 10px; border-radius: 20px; }
    .game-canvas-wrap {
      background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 40%, #FFF5E6 100%);
      border-radius: var(--radius);
      overflow: hidden;
      aspect-ratio: 16/10;
      position: relative;
      box-shadow: 0 4px 24px rgba(0,0,0,0.12);
      width: 100%;
    }
    .game-ground {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 24%;
      background: linear-gradient(180deg, #8B7355 0%, #6B5344 100%);
      border-top: 4px solid #5D4E37;
    }
    .game-cat {
      position: absolute;
      left: 12%;
      bottom: 24%;
      width: 56px;
      height: 56px;
      background: linear-gradient(145deg, var(--cat-primary), var(--cat-secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      transition: none;
      z-index: 2;
      will-change: transform;
    }
    .game-cat.jump { transform: translateY(-95px); transition: transform 0.22s ease-out; }
    .game-cat.jump.jump-short { transform: translateY(-42px); transition: transform 0.14s ease-out; }
    .game-cat.slide {
      transform: scale(0.55) translateY(14px);
      border-radius: 28px 28px 8px 8px;
      transition: transform 0.4s ease-out;
    }
    .game-cat.punch {
      transform: translateX(16px) scale(1.05);
      transition: transform 0.08s ease-out;
    }
    .game-cat.punch::after {
      content: 'ğŸ‘Š';
      position: absolute;
      left: 85%;
      top: 50%;
      transform: translateY(-50%);
      font-size: 28px;
      animation: punchPop 0.25s ease-out;
    }
    @keyframes punchPop {
      0% { transform: translateY(-50%) scale(0.5); opacity: 0.5; }
      70% { transform: translateY(-50%) scale(1.2); }
      100% { transform: translateY(-50%) scale(1); opacity: 1; }
    }
    .obstacle {
      position: absolute;
      bottom: 24%;
      right: 100%;
      width: 40px;
      height: 44px;
      background: #555;
      border-radius: 8px;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      will-change: right;
    }
    .obstacle.hit {
      animation: obstacleHit 0.3s ease-out forwards;
    }
    @keyframes obstacleHit {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.8; }
      100% { transform: scale(0); opacity: 0; }
    }
    .voice-indicator {
      margin-top: 16px;
      background: #fff;
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    .voice-bar {
      flex: 1;
      height: 24px;
      background: #eee;
      border-radius: 12px;
      overflow: hidden;
    }
    .voice-bar-fill {
      height: 100%;
      width: 30%;
      background: linear-gradient(90deg, var(--cat-primary), var(--cat-secondary));
      border-radius: 12px;
      transition: width 0.1s ease;
    }
    .voice-cmd-text { font-size: 0.9rem; color: #666; min-width: 80px; }
    .voice-cmd-text.active { font-weight: 700; color: var(--cat-secondary); }

    /* ========== 5. ê²°ê³¼ í™”ë©´ ========== */
    .result { text-align: center; max-width: 400px; }
    .result-emoji { font-size: 4rem; margin-bottom: 16px; }
    .result-title { font-size: 1.75rem; font-weight: 800; color: var(--cat-secondary); margin-bottom: 8px; }
    .result-score { font-size: 2.5rem; font-weight: 800; color: var(--cat-primary); margin-bottom: 24px; }
    .result-actions { display: flex; flex-direction: column; gap: 12px; width: 100%; }
    .result-actions button, .result-actions a {
      display: block;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      border: none;
      font-family: inherit;
    }
    .btn-replay { background: linear-gradient(135deg, var(--cat-secondary), var(--cat-primary)); color: #fff; }
    .btn-share { background: #fff; color: var(--cat-secondary); border: 2px solid var(--cat-primary); }
    .btn-achievement { background: #333; color: #fff; }
    .result-achievements {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(0,0,0,0.08);
    }
    .result-achievements h3 { font-size: 0.9rem; color: #666; margin-bottom: 12px; }
    .achievement-badges { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
    .badge { background: #fff; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .badge.unlocked { border: 2px solid var(--cat-accent); }

    /* ì—…ì  ëª©ë¡ ëª¨ë‹¬ */
    .achievement-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 24px;
    }
    .achievement-modal.open { display: flex; }
    .achievement-modal-inner {
      background: #fff;
      border-radius: var(--radius);
      padding: 24px;
      max-width: 360px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .achievement-modal h3 { margin-bottom: 16px; color: var(--cat-secondary); }
    .achievement-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #eee; }
    .achievement-item:last-child { border-bottom: none; }
    .achievement-item .icon { font-size: 1.5rem; }
    .achievement-item .name { font-weight: 600; }
    .achievement-item .cond { font-size: 0.8rem; color: #666; }
    .achievement-item.locked { opacity: 0.6; }
  </style>
</head>
<body>
  <!-- 1. ì¸íŠ¸ë¡œ -->
  <section id="intro" class="screen intro active">
    <div class="intro-logo">CATZ RUN</div>
    <p class="intro-tagline">ìº£ì¸ ëŸ° Â· ìŒì„±ìœ¼ë¡œ ë‹¬ë¦¬ëŠ” ê³ ì–‘ì´</p>
    <div class="intro-cat">ğŸ±</div>
    <p class="intro-desc">ë²„íŠ¼ ì—†ì´ ëª©ì†Œë¦¬ë§Œìœ¼ë¡œ ì í”„Â·ìŠ¬ë¼ì´ë“œ! í¬ê²Œ ë§í• ìˆ˜ë¡ íŒŒì›Œ ì—…. 10~30ì´ˆ ìˆí”Œë ˆì´.</p>
    <button type="button" class="btn-start" data-next="onboarding">ì‹œì‘í•˜ê¸°</button>
    <button type="button" class="btn-secondary" id="btnQuickPlay">ë°”ë¡œ í”Œë ˆì´</button>
  </section>

  <!-- 2. ì˜¨ë³´ë”© -->
  <section id="onboarding" class="screen onboarding">
    <h2>ìŒì„±ìœ¼ë¡œ ì¡°ì‘í•´ìš”</h2>
    <p class="sub">ë§í•˜ë©´ ê³ ì–‘ì´ê°€ ë°˜ì‘í•©ë‹ˆë‹¤. í¬ê²Œ ë§í• ìˆ˜ë¡ íŒŒì›Œ ì—…!</p>
    <div class="voice-cards">
      <div class="voice-card"><div class="icon">ğŸ¦˜</div><div class="cmd">ëƒì˜¹ (ì§§ê²Œ)</div><div class="action">ì§§ì€ ì í”„</div></div>
      <div class="voice-card highlight"><div class="icon">ğŸš€</div><div class="cmd">ëƒ~~~~ì˜¹ (ê¸¸ê²Œ)</div><div class="action">ê¸´ ì í”„</div></div>
      <div class="voice-card"><div class="icon">ğŸ‘Š</div><div class="cmd">ëƒ¥ëƒ¥í€ì¹˜</div><div class="action">ì¥ì• ë¬¼ í€ì¹˜</div></div>
      <div class="voice-card"><div class="icon">ğŸŒ</div><div class="cmd">ìŠ¬ë¼ì´ë“œ / êµ´ëŸ¬</div><div class="action">ì²œì²œíˆ ìŠ¬ë¼ì´ë“œ</div></div>
    </div>
    <div class="mic-demo">
      <div class="mic-circle">ğŸ¤</div>
      <p class="mic-hint">"ëƒì˜¹" ì§§ê²Œ/ê¸¸ê²Œ, "ëƒ¥ëƒ¥í€ì¹˜", "ìŠ¬ë¼ì´ë“œ" ë§í•´ë³´ì„¸ìš”</p>
    </div>
    <button type="button" class="btn-next" data-next="mode_select">ë‹¤ìŒ</button>
  </section>

  <!-- 3. ëª¨ë“œ ì„ íƒ -->
  <section id="mode_select" class="screen mode-select">
    <h2>ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
    <div class="mode-cards">
      <div class="mode-card classic" data-mode="classic">
        <span class="emoji">ğŸƒ</span>
        <div>
          <div class="title">í´ë˜ì‹ ëª¨ë“œ</div>
          <div class="desc">10~20ì´ˆ ê¸°ë³¸ ëŸ¬ë„ˆ. ì í”„Â·ìŠ¬ë¼ì´ë“œë¡œ ì¥ì• ë¬¼ í”¼í•˜ê¸°</div>
        </div>
      </div>
      <div class="mode-card loud" data-mode="loud">
        <span class="emoji">ğŸ”¥</span>
        <div>
          <div class="title">ê´‘ê¸° ëª¨ë“œ</div>
          <div class="desc">ì†Œë¦¬ í´ìˆ˜ë¡ ì†ë„ UP. ë¦¬ì•¡ì…˜ ì½˜í…ì¸  ì¶”ì²œ</div>
        </div>
      </div>
      <div class="mode-card whisper" data-mode="whisper">
        <span class="emoji">ğŸŒ™</span>
        <div>
          <div class="title">ì†ì‚­ì„ ëª¨ë“œ</div>
          <div class="desc">ì‘ê²Œ ë§í•´ì•¼ ì¸ì‹. ASMRí˜• í”Œë ˆì´</div>
        </div>
      </div>
    </div>
  </section>

  <!-- 4. ê²Œì„ í”Œë ˆì´ -->
  <section id="gameplay" class="screen">
    <div class="gameplay-wrap">
      <div class="game-header">
        <span class="game-score">ì ìˆ˜: <span id="gameScore">0</span></span>
        <div class="game-stats">
          <span>ì—ë„ˆì§€ <span id="statEnergy">50</span>%</span>
          <span>ìì‹ ê° <span id="statConf">50</span>%</span>
        </div>
      </div>
      <div class="game-canvas-wrap">
        <div class="game-ground"></div>
        <div id="gameCat" class="game-cat">ğŸ±</div>
        <div id="obstacle" class="obstacle">ğŸª¨</div>
      </div>
      <div class="voice-indicator">
        <span id="voiceCmdText" class="voice-cmd-text">ë§í•´ë³´ì„¸ìš”</span>
        <div class="voice-bar"><div id="voiceBarFill" class="voice-bar-fill" style="width: 20%"></div></div>
      </div>
    </div>
  </section>

  <!-- 5. ê²°ê³¼ -->
  <section id="result" class="screen result">
    <div class="result-emoji" id="resultEmoji">ğŸ‰</div>
    <h2 class="result-title" id="resultTitle">í´ë¦¬ì–´!</h2>
    <p class="result-score">ì ìˆ˜ <span id="resultScore">0</span></p>
    <div class="result-actions">
      <button type="button" class="btn-replay" data-next="mode_select">ë‹¤ì‹œ í•˜ê¸°</button>
      <button type="button" class="btn-share">ê³µìœ í•˜ê¸°</button>
      <a href="#achievement" class="btn-achievement" id="btnAchievement">ì—…ì  ë³´ê¸°</a>
    </div>
    <div class="result-achievements">
      <h3>ì´ë²ˆ í”Œë ˆì´ ì—…ì </h3>
      <div class="achievement-badges">
        <span class="badge unlocked">ğŸ”¥ ê³ ë§‰ íŒŒê´´ì</span>
        <span class="badge">ğŸŒ™ ì†ì‚­ì„ ì¥ì¸</span>
        <span class="badge">âš¡ ì—°ì† 10íšŒ</span>
      </div>
    </div>
  </section>

  <!-- ì—…ì  ëª¨ë‹¬ -->
  <div id="achievementModal" class="achievement-modal">
    <div class="achievement-modal-inner">
      <h3>ğŸ† ì—…ì </h3>
      <div class="achievement-item"><span class="icon">ğŸ”¥</span><div><div class="name">ê³ ë§‰ íŒŒê´´ì</div><div class="cond">í‰ê·  ìŒì„± 80dB ì´ìƒ</div></div></div>
      <div class="achievement-item locked"><span class="icon">ğŸŒ™</span><div><div class="name">ì†ì‚­ì„ ì¥ì¸</div><div class="cond">ì†ì‚­ì„ ëª¨ë“œ 50íšŒ ì„±ê³µ</div></div></div>
      <div class="achievement-item locked"><span class="icon">âš¡</span><div><div class="name">ì—°ì† ì„±ê³µ</div><div class="cond">10ì—°ì† ì¥ì• ë¬¼ íšŒí”¼</div></div></div>
      <div class="achievement-item locked"><span class="icon">ğŸ˜‚</span><div><div class="name">ë©˜ë¶•</div><div class="cond">5íšŒ ì˜¤ì¸ì‹</div></div></div>
      <button type="button" class="btn-next" style="margin-top:16px" onclick="document.getElementById('achievementModal').classList.remove('open')">ë‹«ê¸°</button>
    </div>
  </div>

  <script>
    (function() {
      const screens = document.querySelectorAll('.screen');
      function goTo(id) {
        screens.forEach(s => s.classList.remove('active'));
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
      }

      document.querySelectorAll('[data-next]').forEach(btn => {
        btn.addEventListener('click', function() {
          const next = this.getAttribute('data-next');
          if (next === 'gameplay') return;
          goTo(next);
        });
      });

      document.getElementById('btnQuickPlay').addEventListener('click', function() {
        goTo('gameplay');
        startGame('classic');
      });

      document.querySelectorAll('.mode-card').forEach(card => {
        card.addEventListener('click', function() {
          const mode = this.getAttribute('data-mode');
          goTo('gameplay');
          startGame(mode);
        });
      });

      document.querySelector('.btn-replay').addEventListener('click', function() {
        goTo('mode_select');
      });

      document.getElementById('btnAchievement').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('achievementModal').classList.add('open');
      });

      let gameLoopId = null;
      let recognition = null;

      function startGame(mode) {
        const wrap = document.querySelector('.game-canvas-wrap');
        const cat = document.getElementById('gameCat');
        const obstacle = document.getElementById('obstacle');
        const scoreEl = document.getElementById('gameScore');
        const voiceBar = document.getElementById('voiceBarFill');
        const voiceCmd = document.getElementById('voiceCmdText');

        if (gameLoopId != null) cancelAnimationFrame(gameLoopId);
        if (recognition) try { recognition.stop(); } catch (_) {}

        cat.classList.remove('jump', 'slide');
        obstacle.style.right = '100%';
        obstacle.textContent = 'ğŸª¨';
        let score = 0;
        scoreEl.textContent = '0';
        voiceCmd.textContent = 'ëƒì˜¹(ì§§/ê¸¸) Â· ëƒ¥ëƒ¥í€ì¹˜ Â· ìŠ¬ë¼ì´ë“œ!';

        const OBSTACLE_SPEED = mode === 'loud' ? 0.35 : mode === 'whisper' ? 0.2 : 0.28;
        const JUMP_SHORT_MS = 380;
        const JUMP_LONG_MS = 620;
        const SLIDE_MS = 1000;
        const PUNCH_MS = 420;

        let obstacleRight = 100;
        let isJumping = false;
        let isSliding = false;
        let isPunching = false;
        let jumpEndAt = 0;
        let slideEndAt = 0;
        let punchEndAt = 0;
        let passed = false;
        let obstacleIsHit = false;
        let obstacleRespawnAt = 0;

        function doJump(isLong) {
          if (isSliding || isPunching) return;
          isJumping = true;
          cat.classList.remove('jump', 'jump-short');
          cat.classList.add('jump');
          if (!isLong) cat.classList.add('jump-short');
          jumpEndAt = performance.now() + (isLong ? JUMP_LONG_MS : JUMP_SHORT_MS);
        }
        function doSlide() {
          if (isJumping || isPunching) return;
          isSliding = true;
          slideEndAt = performance.now() + SLIDE_MS;
          cat.classList.add('slide');
          cat.classList.remove('jump', 'jump-short', 'punch');
        }
        function doPunch() {
          if (isJumping || isSliding) return;
          isPunching = true;
          punchEndAt = performance.now() + PUNCH_MS;
          cat.classList.add('punch');
          cat.classList.remove('jump', 'jump-short', 'slide');
        }

        function gameLoop(now) {
          if (!wrap || !document.getElementById('gameplay').classList.contains('active')) {
            return;
          }
          gameLoopId = requestAnimationFrame(gameLoop);

          if (isJumping && now >= jumpEndAt) {
            isJumping = false;
            cat.classList.remove('jump', 'jump-short');
          }
          if (isSliding && now >= slideEndAt) {
            isSliding = false;
            cat.classList.remove('slide');
          }
          if (isPunching && now >= punchEndAt) {
            isPunching = false;
            cat.classList.remove('punch');
          }

          if (obstacleIsHit && now >= obstacleRespawnAt) {
            obstacleIsHit = false;
            obstacle.classList.remove('hit');
            obstacleRight = 100;
            obstacle.style.right = '100%';
            obstacle.textContent = 'ğŸª¨';
            passed = false;
          }

          if (!obstacleIsHit) {
            obstacleRight -= OBSTACLE_SPEED;
            obstacle.style.right = obstacleRight + '%';
          }

          const catRect = cat.getBoundingClientRect();
          const obsRect = obstacle.getBoundingClientRect();

          if (isPunching && !obstacleIsHit && obstacleRight < 85 && obstacleRight > 5) {
            const inPunchRange = obsRect.left < catRect.right + 50 && obsRect.right > catRect.left - 10;
            if (inPunchRange) {
              obstacleIsHit = true;
              obstacleRespawnAt = now + 320;
              obstacle.classList.add('hit');
              obstacle.textContent = 'ğŸ’¥';
              passed = true;
              score++;
              scoreEl.textContent = score;
            }
          }

          const catCenterX = catRect.left + catRect.width / 2;
          const obsCenterX = obsRect.left + obsRect.width / 2;
          const overlapX = Math.abs(catCenterX - obsCenterX) < (catRect.width / 2 + obsRect.width / 2);

          if (overlapX && !obstacleIsHit) {
            const safe = isJumping || isSliding || isPunching;
            if (!safe) {
              document.getElementById('resultScore').textContent = score;
              document.getElementById('resultTitle').textContent = 'ê²Œì„ ì˜¤ë²„';
              document.getElementById('resultEmoji').textContent = 'ğŸ˜¿';
              goTo('result');
              if (gameLoopId != null) cancelAnimationFrame(gameLoopId);
              gameLoopId = null;
              if (recognition) try { recognition.stop(); } catch (_) {}
              return;
            }
            if (!passed) {
              passed = true;
              score++;
              scoreEl.textContent = score;
            }
          } else if (!overlapX) {
            passed = false;
          }

          if (obstacleRight < -15 && !obstacleIsHit) {
            obstacleRight = 100;
            obstacle.style.right = '100%';
            passed = false;
          }

          if (voiceBar) voiceBar.style.width = (25 + Math.random() * 50) + '%';
        }

        gameLoopId = requestAnimationFrame(gameLoop);

        document.addEventListener('keydown', function keyHandler(e) {
          if (!document.getElementById('gameplay').classList.contains('active')) return;
          if (e.code === 'Space') {
            e.preventDefault();
            doJump(true);
          }
          if (e.code === 'ArrowDown') {
            e.preventDefault();
            doSlide();
          }
          if (e.code === 'KeyF') {
            e.preventDefault();
            doPunch();
          }
        });

        if (typeof webkitSpeechRecognition !== 'undefined' || typeof SpeechRecognition !== 'undefined') {
          const SpeechRecognitionCtr = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognitionCtr();
          recognition.continuous = true;
          recognition.interimResults = true;
          recognition.lang = 'ko-KR';
          recognition.onresult = function(e) {
            const last = e.results.length - 1;
            const text = (e.results[last][0].transcript || '').trim();
            if (!e.results[last].isFinal) return;
            const t = text.replace(/\s/g, '');
            if (/[ëƒì•¼][ì•„ì˜¤ìš°ì´]*ì˜¹|ì•¼ì˜¹|ëƒì˜¹/i.test(t)) {
              const isLong = t.length > 4 || /[ì•„ì˜¤ìš°ì´]{2,}|~+/.test(t);
              doJump(isLong);
              voiceCmd.textContent = isLong ? 'ê¸´ ì í”„!' : 'ì§§ì€ ì í”„!';
            }
            if (/ì í”„|ë†’ì´|ë›°ì–´|ë›°ê¸°/i.test(t) && !/[ëƒì•¼].*ì˜¹/.test(t)) {
              doJump(true);
              voiceCmd.textContent = 'ì í”„!';
            }
            if (/ëƒ¥ëƒ¥?í€ì¹˜|ëƒ¥í€ì¹˜/i.test(t)) {
              doPunch();
              voiceCmd.textContent = 'ëƒ¥í€ì¹˜!';
            }
            if (/ìŠ¬ë¼ì´ë“œ|êµ´ëŸ¬|í”¼í•´|ëƒì•„ì˜¹|ë¯¸ë„ëŸ¬/i.test(t)) {
              doSlide();
              voiceCmd.textContent = 'ìŠ¬ë¼ì´ë“œ!';
            }
          };
          try { recognition.start(); } catch (_) {}
        }
      }
    })();
  </script>
</body>
</html>
